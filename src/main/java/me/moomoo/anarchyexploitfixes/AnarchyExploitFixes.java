package me.moomoo.anarchyexploitfixes;

import me.moomoo.anarchyexploitfixes.commands.AnarchyExploitFixesCommand;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.config.LanguageCache;
import me.moomoo.anarchyexploitfixes.modules.AnarchyExploitFixesModule;
import me.moomoo.anarchyexploitfixes.modules.protocollib.ProtocolLibModule;
import org.bstats.bukkit.Metrics;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;
import org.reflections.Reflections;
import org.reflections.scanners.Scanners;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.util.*;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;
import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class AnarchyExploitFixes extends JavaPlugin {

    private static AnarchyExploitFixes instance;
    private static Logger logger;
    private static Config config;
    private static HashMap<String, LanguageCache> languageCacheMap;
    private static int minorMCVersion = Integer.MIN_VALUE;
    private static double tps;

    public final SortedMap<String, Boolean> enabledModules = new TreeMap<>();
    public final HashSet<UUID> connectionMsgs = new HashSet<>();
    public final HashSet<UUID> playersInNewChunks = new HashSet<>();
    public final HashMap<UUID, HashSet<String>> playersAndTheirMessages = new HashMap<>();

    @Override
    public void onEnable() {
        instance = this;
        logger = getLogger();

        // Fancy enable
        logger.info("                                                          ");
        logger.info("                                                          ");
        logger.info("     █████  ███████ ███████                               ");
        logger.info("    ██   ██ ██      ██             AnarchyExploitFixes    ");
        logger.info("    ███████ █████   █████            Made by moom0o       ");
        logger.info("    ██   ██ ██      ██             Rewritten by xGinko    ");
        logger.info("    ██   ██ ███████ ██                                    ");
        logger.info("                                                          ");
        logger.info("                                                          ");

        try {
            tps = getServer().getTPS()[0];
        } catch (NoSuchMethodError error) {
            logger.severe("##########################################################");
            logger.severe("#                                                        #");
            logger.severe("#                         ERROR                          #");
            logger.severe("#                                                        #");
            logger.severe("#    This plugin requires at least a paper or paper      #");
            logger.severe("#                      type server.                      #");
            logger.severe("#                                                        #");
            logger.severe("##########################################################");
            getServer().getPluginManager().disablePlugin(this);
            return;
        }

        // Detect Minecraft version.
        // Returns 12, if minecraft version is 1.12.x, 19 if version is 1.19.x, and so on.
        Matcher minorMCVersionFinder = Pattern.compile("\\(MC: \\d\\.(\\d+)(?:\\.\\d+)?\\)").matcher(getServer().getVersion());
        if (!minorMCVersionFinder.find()) {
            logger.severe("##########################################################");
            logger.severe("#                                                        #");
            logger.severe("#                         ERROR                          #");
            logger.severe("#                                                        #");
            logger.severe("#  Report this along with your server type and version   #");
            logger.severe("#                 to the plugins github:                 #");
            logger.severe("#     https://github.com/moom0o/AnarchyExploitFixes      #");
            logger.severe("#                                                        #");
            logger.severe("#      An error occurred while trying to determine       #");
            logger.severe("#    the game's version. Because several features of     #");
            logger.severe("#   this plugin rely on knowing the version, an error    #");
            logger.severe("#   while parsing the value could lead to potentially    #");
            logger.severe("#                  dangerous behavior.                   #");
            logger.severe("#      For this reason the plugin will disable now.      #");
            logger.severe("#                                                        #");
            logger.severe("##########################################################");
            logger.severe("                                                          ");
            logger.severe("  Server name:                                            ");
            logger.severe("  '"+getServer().getName()+"'                             ");
            logger.severe("  Server version:                                         ");
            logger.severe("  '"+getServer().getVersion()+"'                          ");
            logger.severe("                                                          ");
            getServer().getPluginManager().disablePlugin(this);
            return;
        } else {
            minorMCVersion = Integer.parseInt(minorMCVersionFinder.group(1));
            logger.info("Detected Version 1." + minorMCVersion);
            if (minorMCVersion < 12) {
                logger.warning("##########################################################");
                logger.warning("#                                                        #");
                logger.warning("#                         WARNING                        #");
                logger.warning("#                                                        #");
                logger.warning("#    This plugin was made for Minecraft Versions 1.12    #");
                logger.warning("#    and up. Using it in earlier versions can lead to    #");
                logger.warning("#   unexpected errors and you will receive no support.   #");
                logger.warning("#                                                        #");
                logger.warning("##########################################################");
            }
        }

        logger.info("Loading Translations");
        reloadLang();

        logger.info("Loading Config");
        reloadConfiguration();

        logger.info("Registering Commands");
        AnarchyExploitFixesCommand.reloadCommands();

        logger.info("Loading metrics");
        new Metrics(this, 8700);

        // Scheduled TPS checker
        Executors.newScheduledThreadPool(1).scheduleAtFixedRate(
                () -> new Thread(() -> tps = getServer().getTPS()[0]).start(), 1, 1, TimeUnit.SECONDS
        );

        logger.info("Done.");
    }

    public static LanguageCache getLang(String lang) {
        lang = lang.replace("-", "_");
        if (config.auto_lang) {
            return languageCacheMap.getOrDefault(lang, languageCacheMap.get(config.default_lang.toString().toLowerCase()));
        } else {
            return languageCacheMap.get(config.default_lang.toString().toLowerCase());
        }
    }

    public static LanguageCache getLang(Locale locale) {
        return getLang(locale.toString().toLowerCase());
    }

    public static LanguageCache getLang(CommandSender commandSender) {
        if (commandSender instanceof Player) {
            return getLang(((Player) commandSender).getLocale());
        } else {
            return getLang(config.default_lang);
        }
    }

    public void reloadPlugin() {
        reloadLang();
        reloadConfiguration();
        AnarchyExploitFixesCommand.reloadCommands();
    }

    private void reloadConfiguration() {
        config = new Config();
        AnarchyExploitFixesModule.reloadModules();
        ProtocolLibModule.reloadModules();
        config.saveConfig();
    }

    private void reloadLang() {
        languageCacheMap = new HashMap<>();
        try {
            File langDirectory = new File(getDataFolder() + File.separator + "lang");
            Files.createDirectories(langDirectory.toPath());
            for (String fileName : getDefaultLanguageFiles()) {
                String localeString = fileName.substring(fileName.lastIndexOf('/') + 1, fileName.lastIndexOf('.'));
                logger.info(String.format("Found language file for %s", localeString));
                LanguageCache langCache = new LanguageCache(localeString);
                languageCacheMap.put(localeString, langCache);
            }
            Pattern langPattern = Pattern.compile("([a-z]{1,3}_[a-z]{1,3})(\\.yml)", Pattern.CASE_INSENSITIVE);
            for (File langFile : langDirectory.listFiles()) {
                Matcher langMatcher = langPattern.matcher(langFile.getName());
                if (langMatcher.find()) {
                    String localeString = langMatcher.group(1).toLowerCase();
                    if(!languageCacheMap.containsKey(localeString)) { // make sure it wasn't a default file that we already loaded
                        logger.info(String.format("Found language file for %s", localeString));
                        LanguageCache langCache = new LanguageCache(localeString);
                        languageCacheMap.put(localeString, langCache);
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
            logger.severe("Error loading language files! Language files will not reload to avoid errors, make sure to correct this before restarting the server!");
        }
    }

    private Set<String> getDefaultLanguageFiles(){
        Reflections reflections = new Reflections("lang", Scanners.Resources);
        return reflections.getResources(Pattern.compile("([a-z]{1,3}_[a-z]{1,3})(\\.yml)"));
    }

    public static Set<String> getLoadedTranslationStrings() {
        return languageCacheMap.keySet();
    }

    public static AnarchyExploitFixes getInstance()  {
        return instance;
    }

    public static Config getConfiguration() {
        return config;
    }

    public static Logger getLog() {
        return logger;
    }

    public static int getMCVersion() {
        return minorMCVersion;
    }

    public static double getTPSofLastSecond() {
        return tps;
    }

    public static boolean isProtocolLibInstalled() {
        return instance.getServer().getPluginManager().isPluginEnabled("ProtocolLib");
    }

}
