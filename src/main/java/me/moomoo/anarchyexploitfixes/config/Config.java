package me.moomoo.anarchyexploitfixes.config;

import io.github.thatsmusic99.configurationmaster.api.ConfigFile;
import io.github.thatsmusic99.configurationmaster.api.ConfigSection;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;

import java.io.File;
import java.io.IOException;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.logging.Logger;

public class Config {

    private ConfigFile config;
    private final File configFile;
    public final Locale default_lang;
    private final Logger logger;
    public final boolean auto_lang, protocolLib_IsDisabled, connectionMsgsAreOnByDefault, kickPhraseCommandIsEnabled;
    public final double config_version;
    public final int nether_ceiling_max_y, nether_floor_min_y, overworld_floor_min_y;
    public final String sayCommandFormat;

    public Config() {
        configFile = new File(AnarchyExploitFixes.getInstance().getDataFolder(), "config.yml");
        logger = AnarchyExploitFixes.getLog();
        createFiles();
        loadConfig();

        // Config Version - This has no function yet but can be used to parse older configs to new versions in the future.
        this.config_version = getDouble("config-version", 1.0);

        // Language Settings
        config.addSection("Language");
        config.addDefault("language", null); // force config order of language
        this.default_lang = Locale.forLanguageTag(getString("language.default-language", "en_us", "The default language that will be used if auto-language is false or no matching language file was found.").replace("_", "-"));
        this.auto_lang = getBoolean("language.auto-language", true, "If set to true, will display messages based on client language");

        // General Settings
        config.addSection("General");
        config.addDefault("general", null); // force config order of general
        this.protocolLib_IsDisabled = getBoolean("general.disable-all-ProtocolLib", false, "Use only if you are having problems with ProtocolLib when starting the plugin.");
        this.nether_ceiling_max_y = getInt("general.nether-ceiling-y", 127, "The Y-level at which the nether ceiling generates the last layer of bedrock on your server.");
        this.nether_floor_min_y = getInt("general.nether-floor-y", 0, "The Y-level at which the nether floor generates the last layer of bedrock on your server.");
        this.overworld_floor_min_y = getInt("general.overworld-floor-y", AnarchyExploitFixes.getMCVersion() > 17 ? -64 : 0, "The Y-level at which the overworld floor generates the last layer of bedrock on your server.");

        // Force the order of the rest of the configuration file
        config.addSection("Patches");
        config.addDefault("patches", null);
        config.addSection("Preventions");
        config.addDefault("preventions", null);
        config.addSection("Lag Preventions");
        config.addDefault("lag-preventions", null);
        config.addSection("Dupe Preventions");
        config.addDefault("dupe-preventions", null);
        config.addSection("Illegals");
        config.addDefault("illegals", null);
        config.addSection("Chunk Limits");
        config.addDefault("chunk-limits",null);
        config.addSection("Bedrock");
        config.addDefault("bedrock", null);

        config.addSection("Elytra");
        config.addDefault("elytra", null);
        config.addDefault("elytra.elytra-speed.display-actionbar", true);
        config.addDefault("elytra.elytra-speed.display-chunk-info-in-actionbar", true);

        config.addSection("Chat");
        config.addDefault("chat", null);

        // Misc
        config.addSection("Miscellaneous");
        config.addDefault("misc", null);
        // Say Command Format
        this.sayCommandFormat = getString("misc.say-command-format", "&7Server: &6%message%");
        // Join/Leave messages
        config.addDefault("misc.join-leave-messages.enable", true); // add default here so enable option shows up first.
        this.connectionMsgsAreOnByDefault = getBoolean("misc.join-leave-messages.connection-messages-on-by-default", true, "default mode of /toggleconnectionmsgs");
        config.addDefault("misc.join-leave-messages.show-in-console", false); // add default here so show-in-console option is not misplaced.
        this.kickPhraseCommandIsEnabled = getBoolean("misc.enable-kickphrase-command", false, "Enable the /aef kickphrase <phrase> command.");

        // 1b1t Options last like in the original version
        config.addSection("1b1t Options");
        config.addDefault("1b1t-options", null);
    }

    private void createFiles() {
        try {
            File parent = new File(configFile.getParent());
            if (!parent.exists()) {
                if (!parent.mkdir()) logger.severe("Unable to create plugin config directory.");
            }
            if (!configFile.exists()) {
                configFile.createNewFile(); // Result can be ignored because this method only returns false if the file already exists,
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void loadConfig() {
        try {
            config = ConfigFile.loadConfig(configFile);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void saveConfig() {
        try {
            config.save();
        } catch (IOException e) {
            logger.severe("Failed to save config file! - " + e.getLocalizedMessage());
        }
    }

    public boolean getBoolean(String path, boolean def, String comment) {
        config.addDefault(path, def, comment);
        return config.getBoolean(path, def);
    }

    public boolean getBoolean(String path, boolean def) {
        config.addDefault(path, def);
        return config.getBoolean(path, def);
    }

    public String getString(String path, String def, String comment) {
        config.addDefault(path, def, comment);
        return config.getString(path, def);
    }

    public String getString(String path, String def) {
        config.addDefault(path, def);
        return config.getString(path, def);
    }

    public double getDouble(String path, Double def, String comment) {
        config.addDefault(path, def, comment);
        return config.getDouble(path, def);
    }

    public double getDouble(String path, Double def) {
        config.addDefault(path, def);
        return config.getDouble(path, def);
    }

    public int getInt(String path, int def, String comment) {
        config.addDefault(path, def, comment);
        return config.getInteger(path, def);
    }

    public int getInt(String path, int def) {
        config.addDefault(path, def);
        return config.getInteger(path, def);
    }

    public List<String> getList(String path, List<String> def, String comment) {
        config.addDefault(path, def, comment);
        return config.getStringList(path);
    }

    public List<String> getList(String path, List<String> def) {
        config.addDefault(path, def);
        return config.getStringList(path);
    }

    public ConfigSection getConfigSection(String path, Map<String, Object> defaultKeyValue) {
        config.makeSectionLenient(path);
        config.addDefault(path, defaultKeyValue);
        return config.getConfigSection(path);
    }

    public ConfigSection getConfigSection(String path, Map<String, Object> defaultKeyValue, String comment) {
        config.makeSectionLenient(path);
        config.addDefault(path, defaultKeyValue, comment);
        return config.getConfigSection(path);
    }

    public void addComment(String path, String comment) {
        config.addComment(path, comment);
    }
}
